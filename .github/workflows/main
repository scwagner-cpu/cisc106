from drafter import *
from dataclasses import dataclass, field
from bakery import assert_equal
from collections import Counter
from typing import List, Dict, Set
import random

# Site info
set_site_information(
    author="scwagner@udel.edu",
    description=(
        "This website is a game called Nest Quest where you play as a duck, "
        "exploring the world for resources to build various types of nests."
    ),
    sources=["https://github.com/scwagner-cpu/cisc106"],
    planning=["Nest Quest.pdf"],
    links=["https://github.com/scwagner-cpu/cisc106"]
)
hide_debug_information()
set_website_title("Nest Quest")
set_website_framed(False)

# Data structures
@dataclass
class Item:
    """An item you can collect"""
    name: str
    description: str
    value: int = 0

@dataclass
class State:
    """Keeps track of game state"""
    duck_name: str = "Duck"
    current_location: str = "home"
    coins: int = 0
    inventory: List[Item] = field(default_factory=list)
    visited_locations: List[str] = field(default_factory=list)
    nest_progress: int = 0
    lifetime_coins: int = 0

# Helper functions
def collected_item_names(state: State) -> Set[str]:
    """Gets all the item names in inventory"""
    return {item.name for item in state.inventory}

def item_counts(state: State) -> Dict[str, int]:
    """Counts how many of each item you have"""
    return dict(Counter(item.name for item in state.inventory))

def determine_nest_type(state: State) -> str:
    """Figures out what type of nest you can build"""
    names = collected_item_names(state)
    # check all the nest types
    if {"reeds", "sticks", "moss"}.issubset(names):
        return "Cozy Nest"
    if {"pebble", "feathers"}.issubset(names):
        return "Decorative Nest"
    if {"cloth", "twine", "moss"}.issubset(names):
        return "Luxury Nest"
    if {"sticks", "cloth"}.issubset(names):
        return "Survival Nest"
    if {"berries", "reeds"}.issubset(names):
        return "Berry Nest"
    if names:
        return "Mixed Materials Nest"
    return "No Nest Yet"

def update_nest_progress(state: State) -> None:
    """Updates the progress percentage"""
    required = ["reeds", "sticks", "moss", "feathers", "twine", "cloth"]
    collected = collected_item_names(state)
    score = sum(1 for r in required if r in collected)
    state.nest_progress = int((score / len(required)) * 100)

def pond_image(state: State) -> str:
    """Shows different image based on if you collected reeds"""
    if "reeds" in collected_item_names(state):
        return "pond_empty.png"
    else:
        return "pond_with_reeds.png"

def forest_image(state: State) -> str:
    """Shows different image based on if you collected sticks"""
    if "sticks" in collected_item_names(state):
        return "forest_empty.png"
    else:
        return "forest_with_sticks.png"

def meadow_image(state: State) -> str:
    """Shows different image based on if you collected feathers"""
    if "feathers" in collected_item_names(state):
        return "meadow_empty.png"
    else:
        return "meadow_with_feathers.png"

def hill_image(state: State) -> str:
    """Shows different image based on if you collected cloth/twine"""
    names = collected_item_names(state)
    if "twine" in names or "cloth" in names:
        return "hill_empty.png"
    else:
        return "hill_with_cloth.png"

# Routes
@route
def index(state: State) -> Page:
    """Title page where you name your duck"""
    return Page(state, [
        change_text_size(change_text_font(bold("ü™∫ Nest Quest ü¶Ü"), "Verdana"), 45),
        "",
        "Welcome to Nest Quest! You're a duck on a mission to build the best nest.",
        "",
        "Enter your duck's name:",
        TextBox("duck_name", ""),
        Button("‚ñ∂Ô∏è Start Game", start_game)
    ])

@route
def start_game(state: State, duck_name: str) -> Page:
    """Starts the game with your duck name"""
    state.duck_name = duck_name.strip() or "Duck"
    state.current_location = "home"
    state.coins = 0
    state.inventory = []
    state.visited_locations = []
    state.nest_progress = 0
    state.lifetime_coins = 0
    return home(state)

@route
def home(state: State) -> Page:
    """Main home page with all the navigation"""
    state.current_location = "home"
    update_nest_progress(state)
    nest_type = determine_nest_type(state)
    if state.nest_progress >= 100:
        nest_msg = f"‚ú® Your nest is complete! ({nest_type}) ‚ú®"
    else:
        nest_msg = f"Your nest is {state.nest_progress}% complete. Type: {nest_type}"

    return Page(state, [
        f"Welcome home, {state.duck_name}! üè†",
        "",
        nest_msg,
        f"Coins: {state.coins} üí∞",
        "",
        Button("üåä Travel to Pond", pond),
        Button("üå≤ Travel to Forest", forest),
        Button("üèòÔ∏è Travel to Town", town),
        Button("üåº Travel to Meadow", meadow),
        Button("‚õ∞Ô∏è Travel to Hill", hill),
        Button("üéÆ Play Forage Minigame", forage_minigame),
        Button("üìä View Summary", summary)
    ])

@route
def pond(state: State) -> Page:
    """Pond location where you find reeds"""
    state.current_location = "pond"
    if "pond" not in state.visited_locations:
        state.visited_locations.append("pond")

    return Page(state, [
        "üåæ The Pond ‚Äî a quiet pool where reeds grow.",
        "",
        Image(pond_image(state)),
        "",
        Button("üåæ Collect reeds", collect_reeds),
        Button("‚Ü©Ô∏è Return Home", home)
    ])

@route
def collect_reeds(state: State) -> Page:
    """Collects reeds if you don't have them yet"""
    if not any(i.name == "reeds" for i in state.inventory):
        state.inventory.append(Item("reeds", "Soft pond reeds for nest lining"))
        msg = "You collected soft reeds! üåæ"
        # random chance to find a coin
        if random.random() < 0.25:
            state.coins += 1
            state.lifetime_coins += 1
            msg += " You found a coin! üí∞"
    else:
        msg = "You already have reeds."

    return Page(state, [
        msg,
        "",
        Button("‚Ü©Ô∏è Return Home", home)
    ])

@route
def forest(state: State) -> Page:
    """Forest location where you find sticks"""
    state.current_location = "forest"
    if "forest" not in state.visited_locations:
        state.visited_locations.append("forest")

    return Page(state, [
        "üå≤ The Forest ‚Äî lots of sticks and hidden surprises.",
        "",
        Image(forest_image(state)),
        "",
        Button("ü™µ Collect sticks", collect_sticks),
        Button("‚Ü©Ô∏è Return Home", home)
    ])

@route
def collect_sticks(state: State) -> Page:
    """Collects sticks if you don't have them"""
    if not any(i.name == "sticks" for i in state.inventory):
        state.inventory.append(Item("sticks", "Strong twigs for the nest frame"))
        msg = "You found sturdy sticks! ü™µ"
        if random.random() < 0.25:
            state.coins += 1
            state.lifetime_coins += 1
            msg += " You found a coin! üí∞"
    else:
        msg = "You already have sticks."

    return Page(state, [
        msg,
        "",
        Button("‚Ü©Ô∏è Return Home", home)
    ])

@route
def meadow(state: State) -> Page:
    """Meadow location where you find feathers"""
    state.current_location = "meadow"
    if "meadow" not in state.visited_locations:
        state.visited_locations.append("meadow")

    return Page(state, [
        "üåº The Meadow ‚Äî feathers drift on the breeze.",
        "",
        Image(meadow_image(state)),
        "",
        Button("ü™∂ Collect feathers", collect_feathers),
        Button("‚Ü©Ô∏è Return Home", home)
    ])

@route
def collect_feathers(state: State) -> Page:
    """Collects feathers"""
    if not any(i.name == "feathers" for i in state.inventory):
        state.inventory.append(Item("feathers", "Soft feathers for insulation"))
        msg = "You gathered feathers! ü™∂"
        if random.random() < 0.15:
            state.coins += 1
            state.lifetime_coins += 1
            msg += " You found a coin! üí∞"
    else:
        msg = "You already have feathers."

    return Page(state, [
        msg,
        "",
        Button("‚Ü©Ô∏è Return Home", home)
    ])

@route
def hill(state: State) -> Page:
    """Hill location where you might find twine or cloth"""
    state.current_location = "hill"
    if "hill" not in state.visited_locations:
        state.visited_locations.append("hill")

    return Page(state, [
        "‚õ∞Ô∏è The Hill ‚Äî rocky, maybe useful scraps here.",
        "",
        Image(hill_image(state)),
        "",
        Button("üîé Search the hill", search_hill),
        Button("‚Ü©Ô∏è Return Home", home)
    ])

@route
def search_hill(state: State) -> Page:
    """Search for twine or cloth - random what you find"""
    msg = "You searched but didn't find anything useful."
    names = collected_item_names(state)
    rand_val = random.random()
    
    if "twine" not in names and rand_val < 0.40:
        state.inventory.append(Item("twine", "Strong twine for binding"))
        msg = "You found twine! üßµ"
    elif "cloth" not in names and rand_val < 0.65:
        state.inventory.append(Item("cloth", "A scrap of cloth‚Äîdurable"))
        msg = "You found cloth! üß∂"

    return Page(state, [
        msg,
        "",
        Button("‚Ü©Ô∏è Return Home", home)
    ])

@route
def town(state: State) -> Page:
    """Shop where you can buy items with coins"""
    state.current_location = "town"
    if "town" not in state.visited_locations:
        state.visited_locations.append("town")

    return Page(state, [
        "üèòÔ∏è Duck Town ‚Äî a small shop with useful items.",
        "",
        Image("town.png"),
        "",
        f"You have {state.coins} coins. üí∞",
        "",
        SelectBox("item_choice", [
            "Soft moss",
            "Shiny pebble",
            "Bundle of twine",
            "Cloth scrap"
        ]),
        Button("üõí Buy Item", buy_item),
        Button("‚Ü©Ô∏è Return Home", home)
    ])

@route
def buy_item(state: State, item_choice: str) -> Page:
    """Handles buying items from the shop"""
    choice = item_choice.lower()
    if "moss" in choice:
        cost, name, desc = 3, "moss", "Soft moss for nest comfort"
    elif "pebble" in choice:
        cost, name, desc = 2, "pebble", "A decorative shiny pebble"
    elif "twine" in choice:
        cost, name, desc = 3, "twine", "Strong twine for binding"
    elif "cloth" in choice:
        cost, name, desc = 4, "cloth", "A scrap of cloth‚Äîdurable"
    else:
        return Page(state, ["Invalid item.", Button("‚Ü©Ô∏è Return Home", home)])

    if state.coins < cost:
        msg = f"Not enough coins! You need {cost}."
    elif any(i.name == name for i in state.inventory):
        msg = f"You already have {name}."
    else:
        state.coins -= cost
        state.inventory.append(Item(name, desc, cost))
        msg = f"You bought {name}! {desc}"

    return Page(state, [
        msg,
        "",
        Button("‚Ü©Ô∏è Return Home", home)
    ])

@route
def forage_minigame(state: State) -> Page:
    """Minigame where you pick a bush and might find berries or coins"""
    state.current_location = "forage_minigame"
    if "forage_minigame" not in state.visited_locations:
        state.visited_locations.append("forage_minigame")

    return Page(state, [
        "üéÆ Forage Minigame: pick a bush to search!",
        "",
        Image("forage.png"),
        "",
        Button("üå≥", forage_A),
        Button("üå≥", forage_B),
        Button("üå≥", forage_C),
        Button("‚Ü©Ô∏è Return Home", home)
    ])

@route
def forage_A(state: State) -> Page:
    """Bush A choice"""
    return forage_choice(state, "A")

@route
def forage_B(state: State) -> Page:
    """Bush B choice"""
    return forage_choice(state, "B")

@route
def forage_C(state: State) -> Page:
    """Bush C choice"""
    return forage_choice(state, "C")

def forage_choice(state: State, choice: str) -> Page:
    """Handles the random outcome of picking a bush - can't unit test randomness"""
    bushes = ["A", "B", "C"]
    berry_bush = bushes[random.randint(0, 2)]
    if choice == berry_bush:
        state.inventory.append(Item("berries", "Sweet berries"))
        msg = "You found berries! üçì"
    else:
        if random.random() < 0.5:
            state.coins += 1
            state.lifetime_coins += 1
            msg = "You found a coin! üí∞"
        else:
            msg = "Nothing here."

    return Page(state, [
        msg,
        "",
        Image("forage.png"),
        "",
        Button("üîÅ Play Again", forage_minigame),
        Button("‚Ü©Ô∏è Return Home", home)
    ])

@route
def restart(state: State) -> Page:
    """Restarts the game but keeps your duck name"""
    return start_game(state, state.duck_name)

@route
def summary(state: State) -> Page:
    """Shows your progress and what nests you can build"""
    update_nest_progress(state)
    nest_type = determine_nest_type(state)
    counts = item_counts(state)

    inventory_lines = []
    if counts:
        for name, qty in sorted(counts.items()):
            inventory_lines.append(f"- **{name}** √ó {qty}")
    else:
        inventory_lines = ["No items collected yet."]

    # check what nests you can build
    nests = [
        ("Cozy Nest", ["reeds", "sticks", "moss"]),
        ("Decorative Nest", ["pebble", "feathers"]),
        ("Luxury Nest", ["cloth", "twine", "moss"]),
        ("Survival Nest", ["sticks", "cloth"]),
        ("Berry Nest", ["berries", "reeds"]),
    ]
    have = collected_item_names(state)
    possible_lines = []
    for label, reqs in nests:
        missing = [r for r in reqs if r not in have]
        if not missing:
            possible_lines.append(f"‚Ä¢ {label} ‚Äî ready to build ‚úÖ")
        else:
            possible_lines.append(f"‚Ä¢ {label} ‚Äî missing: {', '.join(missing)}")

    return Page(state, [
        "# üìä Your Nesting Progress",
        "",
        Image("home.png"),
        "",
        f"**Duck:** {state.duck_name}",
        f"**Nest Type:** {nest_type}",
        f"**Progress:** {state.nest_progress}%",
        f"**Coins:** {state.coins} (lifetime: {state.lifetime_coins})",
        "",
        "### üß∞ Inventory:",
        *inventory_lines,
        "",
        "### ü™∫ Nest Options:",
        *possible_lines,
        "",
        Button("‚Ü©Ô∏è Return Home", home),
        Button("üîÑ Restart Game", restart)
    ])

# Unit tests
# Test index page loads
s1 = State()
p1 = index(s1)
assert_equal("Nest Quest" in str(p1.content), True)

# Test start game with name
s2 = State()
start_game(s2, "Quackers")
assert_equal(s2.duck_name, "Quackers")

# Test empty name becomes Duck
s3 = State()
start_game(s3, "")
assert_equal(s3.duck_name, "Duck")

# Test home shows duck name
s4 = State(duck_name="Waddles")
p2 = home(s4)
assert_equal("Waddles" in str(p2.content), True)

# Test pond visited
s5 = State()
pond(s5)
assert_equal("pond" in s5.visited_locations, True)

# Test forest visited
s6 = State()
forest(s6)
assert_equal("forest" in s6.visited_locations, True)

# Test meadow visited
s7 = State()
meadow(s7)
assert_equal("meadow" in s7.visited_locations, True)

# Test collect reeds
s8 = State()
collect_reeds(s8)
assert_equal(len(s8.inventory), 1)
assert_equal(s8.inventory[0].name, "reeds")

# Test collect sticks
s9 = State()
collect_sticks(s9)
assert_equal(len(s9.inventory), 1)
assert_equal(s9.inventory[0].name, "sticks")

# Test collect feathers
s10 = State()
collect_feathers(s10)
assert_equal(len(s10.inventory), 1)
assert_equal(s10.inventory[0].name, "feathers")

# Test buying moss
s11 = State(coins=5)
buy_item(s11, "Soft moss (3 coins)")
assert_equal(len(s11.inventory), 1)
assert_equal(s11.inventory[0].name, "moss")
assert_equal(s11.coins, 2)

# Test buying pebble
s12 = State(coins=5)
buy_item(s12, "Shiny pebble (2 coins)")
assert_equal(s12.inventory[0].name, "pebble")
assert_equal(s12.coins, 3)

# Test buying cloth
s13 = State(coins=4)
buy_item(s13, "Cloth scrap (4 coins)")
assert_equal(s13.inventory[0].name, "cloth")
assert_equal(s13.coins, 0)

# Test not enough coins
s14 = State(coins=1)
buy_item(s14, "Soft moss (3 coins)")
assert_equal(len(s14.inventory), 0)
assert_equal(s14.coins, 1)

# Test collected_item_names helper
s15 = State(inventory=[Item("reeds", ""), Item("sticks", "")])
names = collected_item_names(s15)
assert_equal("reeds" in names, True)
assert_equal("sticks" in names, True)

# Test item_counts helper
s16 = State(inventory=[Item("pebble", ""), Item("pebble", ""), Item("moss", "")])
counts = item_counts(s16)
assert_equal(counts["pebble"], 2)
assert_equal(counts["moss"], 1)

# Test Cozy Nest
s17 = State(inventory=[Item("reeds", ""), Item("sticks", ""), Item("moss", "")])
nest = determine_nest_type(s17)
assert_equal(nest, "Cozy Nest")

# Test Decorative Nest
s18 = State(inventory=[Item("pebble", ""), Item("feathers", "")])
nest2 = determine_nest_type(s18)
assert_equal(nest2, "Decorative Nest")

# Test Berry Nest
s19 = State(inventory=[Item("berries", ""), Item("reeds", "")])
nest3 = determine_nest_type(s19)
assert_equal(nest3, "Berry Nest")

# Test no nest
s20 = State(inventory=[])
nest4 = determine_nest_type(s20)
assert_equal(nest4, "No Nest Yet")

# Test nest progress
s21 = State(inventory=[Item("reeds", ""), Item("sticks", ""), Item("moss", "")])
update_nest_progress(s21)
assert_equal(s21.nest_progress, 50)

# Test forage page loads - can't test randomness
s22 = State()
p3 = forage_minigame(s22)
assert_equal("forage_minigame" in s22.visited_locations, True)

# Test summary shows name
s23 = State(duck_name="Tester")
p4 = summary(s23)
assert_equal("Tester" in str(p4.content), True)

# Test restart keeps name
s24 = State(duck_name="QuackMaster", coins=10)
restart(s24)
assert_equal(s24.duck_name, "QuackMaster")
assert_equal(s24.coins, 0)

start_server(State())
